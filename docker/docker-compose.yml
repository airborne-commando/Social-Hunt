version: "3.8"

services:
  social-hunt:
    image: afterpacket/social-hunt:latest
    # build:
    #   context: ..
    #   dockerfile: docker/Dockerfile
    container_name: social-hunt
    ports:
      - "8000:8000"
    environment:
      # The admin token used to log into the dashboard and protect settings.
      # This overrides the admin_token in data/settings.json
      # Change this to a secure random string.
      # Example: admin_token=MySecureToken123!
      - admin_token=your_secure_token_here

      # Set to 1 to allow uploading new YAML or Python plugins via the Web UI.
      - SOCIAL_HUNT_ENABLE_WEB_PLUGIN_UPLOAD=1

      # Set to 1 to enable "Bootstrap Mode" which allows setting the admin
      # token via the Web UI if one isn't already configured.
      - SOCIAL_HUNT_ENABLE_TOKEN_BOOTSTRAP=0

    volumes:
      # Persist search history, settings, and job results
      - ../data:/app/data

      # Persist custom YAML and Python plugins
      - ../plugins:/app/plugins

      # Optional: persist temporary uploads for reverse image search
      - ../web/temp_uploads:/app/web/temp_uploads

    restart: unless-stopped

  # Optional: Nginx reverse proxy (pick one proxy profile: nginx or apache)
  nginx-proxy:
    image: nginx:1.25-alpine
    profiles: ["proxy", "nginx"]
    depends_on:
      - social-hunt
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped

  # Optional: Apache reverse proxy (pick one proxy profile: nginx or apache)
  apache-proxy:
    image: httpd:2.4
    profiles: ["proxy", "apache"]
    depends_on:
      - social-hunt
    ports:
      - "80:80"
    volumes:
      - ./apache/httpd.conf:/usr/local/apache2/conf/httpd.conf:ro
    restart: unless-stopped

  # Optional: Nginx reverse proxy with SSL (Let's Encrypt or custom certs)
  # Enable with: docker compose --profile ssl up -d
  nginx-ssl:
    image: nginx:1.25-alpine
    profiles: ["ssl", "nginx-ssl"]
    depends_on:
      - social-hunt
      - iopaint
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./ssl/nginx-ssl.conf:/etc/nginx/conf.d/default.conf:ro
      - ./ssl/certbot/www:/var/www/certbot
      - ./ssl/certbot/conf:/etc/letsencrypt
      - ./ssl/certs:/etc/ssl/custom:ro
    restart: unless-stopped

  # Optional: Let's Encrypt helper (run on demand)
  # Example: docker compose --profile certbot run --rm --service-ports certbot
  certbot:
    image: certbot/certbot:latest
    profiles: ["certbot"]
    ports:
      - "80:80"
    volumes:
      - ./ssl/certbot/conf:/etc/letsencrypt
      - ./ssl/certbot/www:/var/www/certbot
    env_file:
      - ./ssl/ssl.env
    command: >
      certonly --standalone --preferred-challenges http --http-01-port 80
      --email ${CERTBOT_EMAIL} --agree-tos --no-eff-email -d ${SSL_DOMAIN}

  # Optional: run IOPaint in a separate container (CPU-only)
  # Enable with: docker compose --profile iopaint up -d
  iopaint:
    image: python:3.11-slim
    profiles: ["iopaint", "ssl"]
    command: >
      sh -c "apt-get update && apt-get install -y --no-install-recommends libgl1 libglib2.0-0 &&
             pip install --upgrade pip &&
             pip install torch==2.1.2 torchvision==0.16.2 --extra-index-url https://download.pytorch.org/whl/cpu &&
             pip install iopaint==1.6.0 --no-cache-dir &&
             iopaint start --host 0.0.0.0 --port 8080 --device cpu"
    ports:
      - "8080:8080"
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G